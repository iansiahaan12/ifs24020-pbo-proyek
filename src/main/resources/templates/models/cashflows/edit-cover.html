<div th:fragment="editCoverCashFlowModal">
  <form
    th:action="@{/cashflows/edit-cover}"
    method="post"
    th:object="${coverCashFlowForm}"
    enctype="multipart/form-data"
    id="coverUploadForm"
  >
    <div class="modal fade" id="editCoverCashFlowModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Upload Foto Bukti</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <!-- Connection Error Alert -->
            <div class="alert alert-warning alert-dismissible fade show" role="alert" id="connectionAlert" style="display: none;">
              <strong>Koneksi Terputus!</strong> Pastikan internet stabil dan server berjalan.
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <!-- Existing error display -->
            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
              <span th:text="${error}"></span>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <input type="hidden" th:field="*{id}" id="editCoverCashFlowId" />

            <div class="mb-3">
              <label for="editCoverCashFlowFile" class="form-label">
                Pilih Foto (Struk/Bukti Transfer/Nota) 
                <span class="text-danger">*</span>
              </label>
              <input
                type="file"
                class="form-control"
                name="coverFile"
                id="editCoverCashFlowFile"
                accept="image/jpeg,image/png,image/gif,image/webp"
                required
              />
              <small class="text-muted">
                Format: JPG, PNG, GIF, WEBP (Max 5MB)
              </small>

              <div class="mt-2" id="imagePreviewContainer" style="display: none;">
                <img id="imagePreview" src="#" alt="Preview" class="img-thumbnail mt-2" style="max-height: 200px;">
              </div>

              <div class="text-danger mt-1" id="fileError"></div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Batal
            </button>
            <button type="submit" class="btn btn-primary" id="submitButton">
              Upload Foto
            </button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('coverUploadForm');
  const submitButton = document.getElementById('submitButton');
  const connectionAlert = document.getElementById('connectionAlert');

  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(form);
    
    // Show loading
    submitButton.disabled = true;
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Mengupload...';
    connectionAlert.style.display = 'none';

    try {
      const response = await fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      });

      if (response.ok) {
        // Success - reload page or show success message
        window.location.reload();
      } else {
        throw new Error(`HTTP ${response.status}`);
      }
      
    } catch (error) {
      console.error('Upload error:', error);
      connectionAlert.style.display = 'block';
      submitButton.disabled = false;
      submitButton.innerHTML = 'Upload Foto';
    }
  });

  // Reset form when modal hides
  document.getElementById('editCoverCashFlowModal').addEventListener('hidden.bs.modal', function() {
    form.reset();
    submitButton.disabled = false;
    submitButton.innerHTML = 'Upload Foto';
    connectionAlert.style.display = 'none';
  });
});

function prepareEditCoverCashFlow(button) {
  const cashFlowId = button.getAttribute('data-id');
  document.getElementById('editCoverCashFlowId').value = cashFlowId;
}
</script>